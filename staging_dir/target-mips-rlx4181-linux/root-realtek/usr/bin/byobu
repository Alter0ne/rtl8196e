#!/bin/sh -e
#
#    byobu - screen wrapper script
#    Copyright (C) 2008-2009 Canonical Ltd.
#
#    Authors: Dustin Kirkland <kirkland@canonical.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

PKG="byobu"
VERSION=3.6
[ -z "$BYOBU_PREFIX" ] && export BYOBU_PREFIX="/usr"
export BYOBU_PREFIX
[ -r "/etc/$PKG/socketdir" ] && . "/etc/$PKG/socketdir" || SOCKETDIR="/var/run/screen"
RUN="$SOCKETDIR/S-$USER"

if [ ! -x "$BYOBU_PREFIX/bin/$PKG" ]; then
	echo "ERROR: Cannot find $BYOBU_PREFIX/bin/$PKG" 2>&1
	echo "ERROR: If you have installed it elsewhere, export BYOBU_PREFIX in your shell" 2>&1
	exit 1
fi

# Add a version argument for debugging purposes
if [ "$#" = "1" ] && [ "$1" = "-v" ]; then
	echo "$PKG version $VERSION"
	screen -v
	exit 0
fi

# Check if we're being autolaunched, and this user explicitly does not want it.
if [ "$0" = "/etc/profile.d/Z98-$PKG.sh" ] && [ -r "$HOME/.$PKG/disable-autolaunch" ]; then
	exit 0
fi

# Sanitize the environment
byobu-janitor --force

# Set window title until https://bugs.launchpad.net/bugs/338722 is fixed in screen
printf "\033]0;${USER}@$(hostname) - ${PKG}\007"

# Allow override of default window list, with BYOBU_WINDOWS environment variable
CUSTOM_WINDOW_SET=0
if [ -r "$BYOBU_WINDOWS" ]; then
	CUSTOM_WINDOW_SET=1
elif [ -r "$HOME/.$PKG/windows.$BYOBU_WINDOWS" ]; then
	CUSTOM_WINDOW_SET=1
	BYOBU_WINDOWS="$HOME/.$PKG/windows.$BYOBU_WINDOWS"
elif [ "$#" = "0" ]; then
	BYOBU_WINDOWS="$HOME/.$PKG/windows"
else
	BYOBU_WINDOWS="/dev/null"
fi
export BYOBU_WINDOWS

# Launch shell, unless the user has default windows set to launch
grep -qs "^[^#]" "$BYOBU_WINDOWS" && DEFAULT_WINDOW= || DEFAULT_WINDOW="shell"

# Check if our terminfo supports 256 colors
$(which tput >/dev/null) && [ $(tput colors 2>/dev/null || echo 0) -eq 256 ] && SCREEN_TERM="-T screen-256color"

# Create or update ssh-agent socket
if [ -S "$SSH_AUTH_SOCK" ] && [ ! -h "$SSH_AUTH_SOCK" ] && [ -w "$RUN" ]; then
	rm -f "$RUN/$PKG.ssh-agent"
	ln -sf "$SSH_AUTH_SOCK" "$RUN/$PKG.ssh-agent"
fi

PROFILE="-c $BYOBU_PREFIX/share/$PKG/profiles/byoburc"
NAME="-S $PKG"
# Zero out $NAME if user has specified a -S
for i in $@; do
	case $i in -S) NAME= ;; esac
done
# Now let's execute screen!
if [ "$#" = "0" ]; then
	out=$(screen -wipe 2>/dev/null) || true
	if [ "$CUSTOM_WINDOW_SET" = "1" ]; then
		# Start new custom window set session
		exec screen $SCREEN_TERM $NAME $PROFILE
	else
		case "$out" in
			*\(*\)*)
				# Select and attach to an existing session
				exec byobu-select-session
			;;
			*)
				# Start new default session
				exec screen $SCREEN_TERM $NAME $PROFILE $DEFAULT_WINDOW
			;;
		esac
	fi
else
	# Launch with command line args
	exec screen $SCREEN_TERM $NAME $PROFILE "$@"
fi
